<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Radar</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        #input-container { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* Spacing between inputs */
        }

        #word-input { 
            background: rgba(255, 255, 255, 0.1); 
            border: 2px solid #9a9ac8; 
            border-radius: 8px; 
            color: white; 
            font-size: clamp(16px, 5vw, 24px); 
            font-weight: bold; 
            text-align: center; 
            padding: clamp(8px, 2vw, 10px) clamp(15px, 4vw, 20px); 
            width: clamp(220px, 60vw, 300px); 
            outline: none; 
            transition: all 0.2s ease; 
            -webkit-text-size-adjust: 100%; 
        }
        #word-input:focus { background: rgba(255, 255, 255, 0.2); transform: scale(1.05); }

        #pos-selector {
            display: flex;
            gap: 10px;
        }
        .pos-option {
            background: rgba(40, 40, 60, 0.9);
            border: 1px solid #9a9ac8;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: clamp(12px, 3vw, 14px);
            font-weight: 600;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .pos-option:hover {
            background: rgba(255, 107, 71, 0.9);
        }
        .pos-option.selected {
            background-color: #FF6B47;
            color: #1a1a2e;
            border-color: #FF6B47;
            transform: scale(1.05);
        }

        #category-input, #custom-words-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed #7a7a9f;
            border-radius: 8px;
            color: white;
            font-size: clamp(12px, 3.5vw, 14px);
            text-align: center;
            padding: 8px 15px;
            width: clamp(220px, 60vw, 300px);
            outline: none;
            transition: all 0.2s ease;
        }
        #category-input::placeholder, #custom-words-input::placeholder {
            color: #9a9ac8;
            opacity: 0.7;
        }
        #category-input:focus, #custom-words-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-style: solid;
        }
        #custom-words-input {
            resize: vertical;
            height: 60px;
            text-align: left;
            padding: 10px;
        }

        #submit-btn {
            background-color: #FF6B47;
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: clamp(14px, 4vw, 16px);
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s ease;
            width: clamp(220px, 60vw, 300px);
        }
        #submit-btn:hover {
            transform: scale(1.05);
            background-color: #ffca85;
        }
        #sense-selector {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            background: rgba(40, 40, 60, 0.95);
            border: 1px solid #9a9ac8;
            border-radius: 12px;
            padding: clamp(20px, 5vw, 30px);
            max-height: 85vh;
            max-width: clamp(300px, 80vw, 500px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        #sense-title {
            margin: 0 0 10px 0;
            font-size: clamp(16px, 4vw, 20px);
            text-align: center;
        }
        #sense-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
        }

        #sense-options::-webkit-scrollbar {
        width: 8px;
        }
        #sense-options::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        }
        #sense-options::-webkit-scrollbar-thumb {
        background-color: #7a7a9f;
        border-radius: 4px;
        }
        #sense-options::-webkit-scrollbar-thumb:hover {
        background-color: #9a9ac8;
        }
        .sense-option-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #7a7a9f;
            border-radius: 8px;
            padding: 12px;
            color: #e0e0e0;
            font-size: clamp(14px, 3.5vw, 16px);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
        }
        .sense-option-btn:hover {
            background: rgba(255, 107, 71, 0.9);
            border-color: #FF6B47;
            color: #1a1a2e;
        }

        #show-more-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed #7a7a9f;
            border-radius: 8px;
            padding: 10px 16px;
            color: #9a9ac8;
            font-size: clamp(12px, 3vw, 14px);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            margin-top: 5px;
            font-style: italic;
        }

        #show-more-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #FF6B47;
            color: #FF6B47;
        }

        .additional-senses {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .additional-senses.expanded {
            max-height: 400px; /* Adjust based on your needs */
        }

        .sense-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #7a7a9f, transparent);
            margin: 15px 0 10px 0;
        }
        @media (max-width: 768px) { 
            #word-input { font-size: 16px; padding: 12px 16px; width: min(80vw, 300px); } 
            #input-container { gap: 12px; }
            .pos-option { padding: 6px 12px; font-size: 12px; }
            #category-input, #custom-words-input { font-size: 12px; padding: 8px 12px; width: min(80vw, 300px); }
        }

        .header-logo { position: absolute; top: clamp(10px, 2vh, 20px); left: clamp(10px, 2vw, 20px); width: clamp(60px, 12vw, 90px); opacity: 1; transition: opacity 0.2s; }
        .header-logo:hover { opacity: 0.7; }
        
        #top-right-controls {
            position: absolute;
            top: clamp(10px, 2vh, 20px);
            right: clamp(10px, 2vw, 20px);
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            z-index: 100;
        }
        .control-btn {
            background: rgba(40, 40, 60, 0.9);
            border: 1px solid #9a9ac8;
            border-radius: 8px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: all 0.2s;
            min-width: 130px;
            justify-content: center;
        }
        .control-btn:hover { background: rgba(60, 60, 80, 0.9); }
        .control-btn .control-icon {
            width: clamp(16px, 4vw, 20px);
            height: clamp(16px, 4vw, 20px);
            margin-right: 8px;
            fill: #c0c0e0;
        }
        .control-btn .control-label {
            font-size: clamp(10px, 2.5vw, 12px);
            font-weight: 600;
            color: #e0e0e0;
        }
        #sound-toggle.sound-off .slash-icon { display: block; }
        #sound-toggle.sound-off path:not(.slash-icon) { opacity: 0.4; }
        #sound-toggle .slash-icon { display: none; }
        
        h1 { color: #ffffff; font-weight: 300; text-align: center; cursor: pointer; transition: color 0.2s; font-size: clamp(1.2rem, 4vw, 2rem); margin: clamp(10px, 2vh, 20px) 10px; padding: 0 10px; }
        h1:hover { color: #ffca85; }
        #chart-container { position: relative; width: calc(100vw - 20px); height: calc(100vh - 80px); max-width: 800px; max-height: 800px; min-width: 300px; min-height: 300px; }
        @media (max-width: 768px) { #chart-container { width: calc(100vw - 10px); height: calc(100vh - 60px); } h1 { font-size: clamp(1rem, 5vw, 1.5rem); margin: 5px; } }
        @media (max-height: 600px) { #chart-container { height: calc(100vh - 40px); } h1 { margin: 5px; } }
        .hidden { display: none !important; }
        #radar-scanner { position: absolute; top: 5%; left: 50%; margin-left: -1px; width: 2px; height: 45%; background: linear-gradient(to top, rgba(255, 107, 71, 0.8) 0%, rgba(255, 107, 71, 0) 100%); transform-origin: bottom center; animation: spin 3s linear infinite; z-index: 5; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .radar-background, .spectrum-view { transition: opacity 0.5s ease-in-out; }
        .radar-ring { stroke: #4f4f7a; stroke-width: 1px; transition: r 0.5s ease-out, opacity 0.5s ease-out; }
        .axis-line { stroke: #5f5f8a; stroke-width: 1.5px; transition: all 0.5s ease-out; }
        .axis-label { fill: #c0c0e0; font-size: clamp(12px, 3vw, 14px); font-weight: 600; text-transform: uppercase; cursor: pointer; transition: fill 0.2s ease-in-out, opacity 0.5s ease-in-out; }
        .axis-label:hover { fill: #ffca85; }
        .axis-label.active { fill: #ffca85; font-weight: 700; }
        .spectrum-axis { stroke: #9a9ac8; stroke-width: 2px; stroke-dasharray: 4 4; }
        .spectrum-label { fill: #c0c0e0; font-size: clamp(12px, 3vw, 14px); font-weight: 600; text-transform: uppercase; text-anchor: middle; }
        .word-bubble, .spectrum-bubble { transition: opacity 0.5s ease-in-out; cursor: grab; }
        .word-bubble circle, .spectrum-bubble circle { cursor: grab; transition: transform 0.2s ease-out, stroke-width 0.2s ease-out, stroke 0.2s ease-out; stroke: #1a1a2e; stroke-width: 2px; }
        .word-bubble:hover circle, .spectrum-bubble:hover circle { transform: scale(1.1); stroke: #ffffff; stroke-width: 3px; }
        .word-bubble.selected circle, .spectrum-bubble.selected circle { stroke: #ffca85; stroke-width: 4px; transform: scale(1.15); }
        .word-bubble.dimmed, .spectrum-bubble.dimmed { opacity: 0.25; pointer-events: none; }
        .word-bubble text, .spectrum-bubble text { fill: #ffffff; font-size: clamp(10px, 2.5vw, 12px); font-weight: bold; text-anchor: middle; pointer-events: none; text-shadow: 0 0 4px #000000; }
        .antonym-bubble circle { fill: #9467bd !important; }
        @media (max-width: 768px) { .word-bubble:active circle, .spectrum-bubble:active circle { transform: scale(1.15); stroke: #ffffff; stroke-width: 3px; } .axis-label:active { fill: #ffca85; } }
        .tooltip { position: absolute; background-color: rgba(40, 40, 60, 0.95); border: 1px solid #9a9ac8; border-radius: 8px; padding: clamp(8px, 2vw, 12px); color: #e0e0e0; opacity: 0; pointer-events: none; transition: opacity 0.2s; max-width: clamp(220px, 70vw, 280px); font-size: clamp(12px, 3vw, 14px); box-shadow: 0 4px 15px rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 1000; }
        .tooltip h3 { margin: 0 0 4px 0; color: #ffffff; font-size: clamp(14px, 3.5vw, 16px); }
        .tooltip p { margin: 0 0 8px 0; font-style: italic; color: #c0c0e0; line-height: 1.3; }
        .tooltip .example { font-style: normal; background-color: rgba(0,0,0,0.2); padding: 4px; border-radius: 4px; font-family: monospace; font-size: clamp(11px, 2.5vw, 13px); }
        .tooltip .metadata { margin-top: 6px; padding-top: 6px; border-top: 1px solid #555; font-size: clamp(10px, 2.5vw, 12px); }
        .tooltip .difficulty { display: inline-block; padding: 2px 4px; border-radius: 3px; font-size: clamp(8px, 2vw, 10px); font-weight: bold; text-transform: uppercase; }
        .difficulty.beginner { background-color: #4CAF50; color: white; }
        .difficulty.intermediate { background-color: #FF9800; color: white; }
        .difficulty.advanced { background-color: #F44336; color: white; }
        .comparison-tooltip { max-width: clamp(300px, 90vw, 500px); }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .comparison-col h4 { margin: 0 0 5px; color: #ffca85; }
        .comparison-col p { font-size: clamp(11px, 2.8vw, 13px); }
        .comparison-close { position: absolute; top: 8px; right: 10px; cursor: pointer; font-size: 18px; color: #aaa; }
        .comparison-close:hover { color: white; }
        
        @media (max-width: 768px) {
            .comparison-tooltip {
                width: 90vw;
                max-width: 90vw;
                left: 5vw !important; 
                top: 50% !important;
                transform: translateY(-50%) !important;
            }
            .comparison-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        .metadata-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .frequency-indicator {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 12px;
        }

        .freq-bar {
            width: 4px;
            background-color: #555;
            border-radius: 1px;
            transition: all 0.2s;
        }
        .freq-bar:nth-child(1) { height: 40%; }
        .freq-bar:nth-child(2) { height: 60%; }
        .freq-bar:nth-child(3) { height: 80%; }
        .freq-bar:nth-child(4) { height: 100%; }
        .freq-1 .freq-bar:nth-child(-n+1),
        .freq-2 .freq-bar:nth-child(-n+2),
        .freq-3 .freq-bar:nth-child(-n+3),
        .freq-4 .freq-bar:nth-child(-n+4) {
            background-color: #9a9ac8;
        }
        
        #legend { position: absolute; bottom: clamp(10px, 2vh, 20px); left: clamp(10px, 2vw, 20px); background: rgba(40, 40, 60, 0.9); border: 1px solid #9a9ac8; border-radius: 8px; padding: clamp(10px, 2vw, 15px); font-size: clamp(10px, 2.5vw, 12px); color: #e0e0e0; max-width: clamp(150px, 35vw, 200px); backdrop-filter: blur(5px); transition: opacity 0.5s ease-in-out; }
        #legend h4 { margin: 0 0 8px 0; color: #ffffff; font-size: clamp(12px, 3vw, 14px); }
        #legend .legend-size-demo { display: flex; align-items: center; gap: 4px; margin: 6px 0; }
        #legend .size-circle { border-radius: 50%; }
        @media (max-width: 768px) { #legend { bottom: 5px; left: 5px; padding: 8px; max-width: min(40vw, 180px); font-size: 10px; } #legend h4 { font-size: 11px; margin-bottom: 6px; } }
        @media (max-height: 600px) { #legend { display: none; } }

       .spectrum-bubble .remove-btn {
            font-size: 18px;
            fill: #ffca85;
            cursor: pointer;
            text-anchor: middle;
            dominant-baseline: middle;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: auto; /* <-- ADD THIS LINE */
        }
        .spectrum-bubble:hover .remove-btn {
            opacity: 1;
        }
        .spectrum-bubble.dragging {
            cursor: grabbing;
        }
        
        #add-word-container {
            position: absolute;
            bottom: clamp(10px, 2vh, 20px);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(40, 40, 60, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #9a9ac8;
            backdrop-filter: blur(5px);
            z-index: 100;
        }
        #add-word-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #7a7a9f;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            padding: 8px 12px;
            outline: none;
        }
        #add-word-btn {
            background-color: #FF6B47;
            border: none;
            color: #1a1a2e;
            font-weight: bold;
            border-radius: 5px;
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #add-word-btn:hover { background-color: #ffca85; }
        #add-word-btn:disabled { background-color: #555; cursor: not-allowed; }

        .spectrum-y-axis-label {
            fill: #9a9ac8;
            font-size: 10px;
            text-transform: uppercase;
            font-style: italic;
        }    
    </style>
</head>
<body>
    <img src="https://eltcation.com/wp-content/uploads/2025/06/ELTcation_left.png" alt="ELTcation Logo" class="header-logo">
    
    <div id="top-right-controls">
        <div id="sound-toggle" class="control-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="control-icon">
                <path d="M16.364 3.636a1 1 0 0 1 0 1.414l-1.414 1.414a5 5 0 0 0 0 7.072l1.414 1.414a1 1 0 0 1-1.414 1.414l-1.414-1.414a7 7 0 0 1 0-9.898l1.414-1.414a1 1 0 0 1 1.414 0zM12 5.05L12 19.05a1 1 0 0 1-1.638.766L6 15H3a1 1 0 0 1-1-1V10a1 1 0 0 1 1-1h3l4.362-4.816A1 1 0 0 1 12 5.05zm7.07 7.07a1 1 0 0 1-1.414-1.414l1.414-1.414a3 3 0 0 0 0-4.242l-1.414-1.414a1 1 0 1 1 1.414-1.414l1.414 1.414a5 5 0 0 1 0 7.07z"/>
                <path class="slash-icon" d="M4.707 3.293a1 1 0 0 1 1.414 0l14.293 14.293a1 1 0 0 1-1.414 1.414L3.293 4.707a1 1 0 0 1 0-1.414z"/>
            </svg>
            <span class="control-label">Sound ON</span>
        </div>
        <div id="export-btn" class="control-btn hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="control-icon">
                <path d="M12 16a1 1 0 0 1-1-1V4a1 1 0 1 1 2 0v11a1 1 0 0 1-1 1zm0 2a1 1 0 0 1-.707-.293l-4-4a1 1 0 1 1 1.414-1.414L12 15.586l3.293-3.293a1 1 0 1 1 1.414 1.414l-4 4A1 1 0 0 1 12 18zm-8 4a1 1 0 0 1-1-1V7a1 1 0 1 1 2 0v13H4zM20 7a1 1 0 1 1-2 0v13h-2a1 1 0 1 1 0-2h2V7z"/>
            </svg>
            <span class="control-label">Export PNG</span>
        </div>
        <div id="restart-btn" class="control-btn hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="control-icon">
                <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-3.293-2.293a1 1 0 0 1 0-1.414l.707-.707A5.001 5.001 0 0 1 12 7a5 5 0 0 1 5 5h-2a3 3 0 0 0-3-3 3 3 0 0 0-2.121.879l.707.707a1 1 0 1 1-1.414 1.414l-2-2a1 1 0 0 1 0-1.414l2-2a1 1 0 1 1 1.414 1.414l-.707.707A7.001 7.001 0 0 1 12 5a7 7 0 0 1 7 7h2a9 9 0 0 0-9-9 9 9 0 0 0-6.364 15.364l-.707.707a1 1 0 0 1-1.414 0z"/>
            </svg>
            <span class="control-label">New Word</span>
        </div>
    </div>

    <h1 id="main-title">Enter a word to build its Radar</h1>
    <div id="chart-container">
        <div id="input-container">
            <form id="word-form">
                <input type="text" id="word-input" placeholder="e.g., see" autocomplete="off">
            </form>
            <div id="pos-selector">
                <div class="pos-option" data-pos="verb">Verb</div>
                <div class="pos-option" data-pos="noun">Noun</div>
                <div class="pos-option" data-pos="adjective">Adjective</div>
                <div class="pos-option" data-pos="adverb">Adverb</div>
            </div>
            <textarea id="custom-words-input" placeholder="Custom Words: Paste comma-separated words to classify instead of using the thesaurus."></textarea>
            <button id="submit-btn" class="hidden">Start</button>
        </div>
        <div id="sense-selector" class="hidden">
            <h3 id="sense-title">Which meaning of "word"?</h3>
            <div id="sense-options"></div>
        </div>
        <div id="radar-scanner" class="hidden"></div>
        <div id="legend" class="hidden">
            <h4>Legend</h4>
            <div style="margin-bottom: 10px;">
                <strong>Bubble Color:</strong>
                <div class="legend-size-demo"><div class="size-circle" style="width: 12px; height: 12px; background-color: #4CAF50;"></div>Beginner</div>
                <div class="legend-size-demo"><div class="size-circle" style="width: 12px; height: 12px; background-color: #FF9800;"></div>Intermediate</div>
                <div class="legend-size-demo"><div class="size-circle" style="width: 12px; height: 12px; background-color: #F44336;"></div>Advanced</div>
            </div>
            <div style="padding-top: 6px; border-top: 1px solid #555;">
                <strong>Bubble Size:</strong>
                <div class="legend-size-demo"><div class="size-circle" style="width: 8px; height: 8px; background-color: #666;"></div>Rare</div>
                <div class="legend-size-demo"><div class="size-circle" style="width: 16px; height: 16px; background-color: #666;"></div>Common</div>
            </div>
        </div>
        
        <div id="add-word-container" class="hidden">
            <input type="text" id="add-word-input" placeholder="Add a word...">
            <button id="add-word-btn">Add</button>    
        </div>
        <div class="tooltip"></div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mainTitle = d3.select("#main-title");
        const inputContainer = d3.select("#input-container");
        const wordForm = d3.select("#word-form");
        const scanner = d3.select("#radar-scanner");
        const tooltip = d3.select(".tooltip");
        const legend = d3.select("#legend");
        const senseSelector = d3.select("#sense-selector");
        const restartBtn = d3.select("#restart-btn");
        const exportBtn = d3.select("#export-btn");
        const addWordContainer = d3.select("#add-word-container");
        const addWordInput = d3.select("#add-word-input");
        const addWordBtn = d3.select("#add-word-btn");
        
        const container = d3.select("#chart-container");
        const containerRect = container.node().getBoundingClientRect();
        const width = containerRect.width;
        const height = containerRect.height;
        
        const isMobile = window.innerWidth <= 768;
        const margin = isMobile ? 65 : 100;
        const maxRadius = (Math.min(width, height) / 2) - margin;
        
        const svg = container.append("svg").attr("width", width).attr("height", height).attr("viewBox", `0 0 ${width} ${height}`).attr("preserveAspectRatio", "xMidYMid meet")
            .on("click", (event) => {
                if (selectedWords.length > 0) { clearComparison(); } 
                else if (currentView !== 'radar') { event.stopPropagation(); switchToRadarView(); }
            });

        const chartGroup = svg.append("g").attr("transform", `translate(${width / 2}, ${height / 2})`);

        let currentView = 'radar', activeSpectrum = null, currentBubbles = null, currentAntonymBubbles = null, spectrumBubbles = null, selectedWords = [], isSoundOn = true, currentRadarData = null, currentSpectrumData = null;

        const bubbleSizeScale = d3.scaleSqrt().domain([0, 100]).range(isMobile ? [5, 20] : [8, 30]);
        const largestBubbleRadius = bubbleSizeScale.range()[1]; 

        const difficultyColors = {
            beginner: '#4CAF50',
            intermediate: '#FF9800',
            advanced: '#F44336'
        };
        
        const radarXScale = d3.scaleLinear().domain([-1.1, 1.1]).range([-maxRadius + largestBubbleRadius, maxRadius - largestBubbleRadius]);
        const radarYScale = d3.scaleLinear().domain([-1.1, 1.1]).range([maxRadius - largestBubbleRadius, -maxRadius + largestBubbleRadius]);

        const spectrumRangeX = maxRadius * 0.8;
        const spectrumRangeY = maxRadius * 0.5;
        const spectrumScale = d3.scaleLinear().domain([-1.1, 1.1]).range([-spectrumRangeX, spectrumRangeX]).clamp(true);
        const spectrumYScale = d3.scaleLinear().domain([-1.1, 1.1]).range([spectrumRangeY, -spectrumRangeY]).clamp(true);

        const radarBgGroup = chartGroup.append("g").attr("class", "radar-background");
        const spectrumGroup = chartGroup.append("g").attr("class", "spectrum-view").style("opacity", 0).attr("pointer-events", "none");
        const bubblesGroup = chartGroup.append("g").attr("class", "bubbles-container");
        const antonymsGroup = chartGroup.append("g").attr("class", "antonyms-container");
        const labelsGroup = chartGroup.append("g").attr("class", "labels-container");
        
        const submitBtn = d3.select("#submit-btn");
        let currentSearch = { word: '', partOfSpeech: '' };
        
        function updateSubmitButtonState() {
            const word = d3.select("#word-input").property("value").trim();
            const posSelected = d3.select(".pos-option.selected").node();
            if (word && posSelected) {
                submitBtn.classed("hidden", false);
            } else {
                submitBtn.classed("hidden", true);
            }
        }

      let inputDebounceTimer;
      d3.select('#word-input').on('input', function() {
          clearTimeout(inputDebounceTimer);
          inputDebounceTimer = setTimeout(() => {
            updateSubmitButtonState();
        }, 150);
      });

        async function handleFormSubmit(event) {
            event.preventDefault();
            currentSearch.word = d3.select("#word-input").property("value").trim();
            const selectedPosNode = d3.select(".pos-option.selected").node();
            const customWords = d3.select("#custom-words-input").property("value").trim();
            if (!currentSearch.word) { alert("Please enter a word."); return; }
            if (!selectedPosNode) { alert("Please select a part of speech."); return; }
            currentSearch.partOfSpeech = selectedPosNode.dataset.pos;
            if (currentView !== 'radar') { await switchToRadarView(); }
            inputContainer.classed("hidden", true);
            legend.classed("hidden", true);
            clearChart();
            if (customWords) {
                const synonyms = customWords.split(',').map(s => s.trim()).filter(Boolean);
                if (synonyms.length > 0) {
                    handleSenseSelection(synonyms);
                    return;
                }
            }
            mainTitle.style("cursor", "default").text(`Discovering meanings for "${currentSearch.word}"...`);
            scanner.classed("hidden", false);
            const discoveryData = await fetchWordData({ word: currentSearch.word, partOfSpeech: currentSearch.partOfSpeech });
            if (discoveryData && discoveryData.senses) {
                scanner.classed("hidden", true);
                mainTitle.text("Please select a meaning to explore");
                senseSelector.select("#sense-title").text(`Which meaning of "${currentSearch.word}"?`);
                senseSelector.select("#sense-options").selectAll("*").remove();
                const primaryOptions = senseSelector.select("#sense-options").selectAll(".primary-sense").data(discoveryData.senses);
                primaryOptions.enter().append("button").attr("class", "sense-option-btn primary-sense").text(d => `"${d.synonyms.slice(0, 3).join('", "')}" ${d.synonyms.length > 3 ? `(+${d.synonyms.length - 3} more)` : ''} — ${d.definition}`).on("click", (e, d) => handleSenseSelection(d.synonyms));
                if (discoveryData.hasMore && discoveryData.additionalSenses) {
                    const showMoreContainer = senseSelector.select("#sense-options").append("div").attr("id", "show-more-container");
                    showMoreContainer.append("div").attr("id", "show-more-btn").text(`+ Show ${discoveryData.additionalSenses.length} more specific meanings`).on("click", function() {
                        const additionalContainer = d3.select("#additional-senses");
                        const isExpanded = additionalContainer.classed("expanded");
                        if (!isExpanded) {
                            additionalContainer.classed("expanded", true);
                            d3.select(this).text("− Show fewer meanings");
                        } else {
                            additionalContainer.classed("expanded", false);
                            d3.select(this).text(`+ Show ${discoveryData.additionalSenses.length} more specific meanings`);
                        }
                    });
                    showMoreContainer.append("div").attr("class", "sense-divider");
                    const additionalContainer = showMoreContainer.append("div").attr("id", "additional-senses").attr("class", "additional-senses");
                    const additionalOptions = additionalContainer.selectAll(".additional-sense").data(discoveryData.additionalSenses);
                    additionalOptions.enter().append("button").attr("class", "sense-option-btn additional-sense").style("opacity", "0.8").style("font-size", "clamp(13px, 3vw, 15px)").text(d => `"${d.synonyms.slice(0, 2).join('", "')}" ${d.synonyms.length > 2 ? `(+${d.synonyms.length - 2})` : ''} — ${d.definition}`).on("click", (e, d) => handleSenseSelection(d.synonyms));
                }
                senseSelector.classed("hidden", false);
            } else if (discoveryData && discoveryData.words) {
                currentRadarData = discoveryData;
                scanner.classed("hidden", true);
                mainTitle.text(`Word Radar: "${discoveryData.hub_word}"`).style("cursor", "pointer");
                updateLegend(discoveryData);
                drawRadarBackground();
                drawWordBubbles(discoveryData);
                legend.classed("hidden", false);
                restartBtn.classed("hidden", false);
                exportBtn.classed("hidden", false);
            } else {
                scanner.classed("hidden", true);
                mainTitle.text(discoveryData.error || `No data for "${currentSearch.word}". Click to try again.`).style("cursor", "pointer");
                restartBtn.classed("hidden", false);
            }
        }

        async function handleSenseSelection(synonyms) {
            senseSelector.classed("hidden", true);
            mainTitle.style("cursor", "default").text(`Generating Radar for "${currentSearch.word}"...`);
            scanner.classed("hidden", false);
            const wordData = await fetchWordData({ word: currentSearch.word, partOfSpeech: currentSearch.partOfSpeech, synonyms });
            currentRadarData = wordData;
            scanner.classed("hidden", true);
            if (wordData && wordData.words) {
                mainTitle.text(`Word Radar: "${wordData.hub_word}"`).style("cursor", "pointer");
                updateLegend(wordData);
                drawRadarBackground();
                drawWordBubbles(wordData);
                legend.classed("hidden", false);
                restartBtn.classed("hidden", false);
                exportBtn.classed("hidden", false);
            } else {
                mainTitle.text(wordData.error || `No data for "${currentSearch.word}". Click to try again.`).style("cursor", "pointer");
                restartBtn.classed("hidden", false);
            }
        }

        function getMetadataHTML(d) {
            const difficultyHTML = d.difficulty ? `<span class="difficulty ${d.difficulty.toLowerCase()}">${d.difficulty}</span>` : '';
            let freqLevel = 0;
            if (d.frequency > 0) {
                freqLevel = Math.ceil((d.frequency / 100) * 4);
            }
            const frequencyHTML = `
                <div class="frequency-indicator freq-${freqLevel}" title="Frequency: ${d.frequency}/100">
                    <div class="freq-bar"></div><div class="freq-bar"></div><div class="freq-bar"></div><div class="freq-bar"></div>
                </div>`;
            return `<div class="metadata"><div class="metadata-item">${difficultyHTML}${frequencyHTML}</div></div>`;
        }

        function handleWordClick(event, d) {
            event.stopPropagation();
            tooltip.style("opacity", 0);
            const node = d3.select(event.currentTarget);
            const isSelected = selectedWords.some(sw => sw.term === d.term);
            if (isSelected) {
                selectedWords = selectedWords.filter(sw => sw.term !== d.term);
                node.classed("selected", false);
            } else {
                if (selectedWords.length < 2) {
                    selectedWords.push(d);
                    node.classed("selected", true);
                }
            }
            if (selectedWords.length === 2) {
                showComparisonTooltip(selectedWords[0], selectedWords[1]);
                const allBubbles = d3.selectAll('.word-bubble, .spectrum-bubble');
                allBubbles.classed("dimmed", data => !selectedWords.some(sw => sw.term === data.term));
            } else {
                tooltip.classed("comparison-tooltip", false);
                d3.selectAll('.word-bubble, .spectrum-bubble').classed("dimmed", false);
            }
        }

        function clearComparison() {
            if (!currentBubbles && !spectrumBubbles) return;
            selectedWords = [];
            d3.selectAll('.word-bubble, .spectrum-bubble').classed("selected", false).classed("dimmed", false);
            tooltip.style("opacity", 0).classed("comparison-tooltip", false);
        }

        function showComparisonTooltip(d1, d2) {
            const content = `
                <div class="comparison-close" onclick="d3.select('.tooltip').style('opacity', 0); d3.selectAll('.word-bubble, .spectrum-bubble').classed('selected dimmed', false); selectedWords = [];">×</div>
                <h3>Comparing Words</h3>
                <div class="comparison-grid">
                    <div class="comparison-col">
                        <h4>${d1.term}</h4><p>${d1.definition}</p><div class="example">e.g., "${d1.example}"</div>${getMetadataHTML(d1)} 
                    </div>
                    <div class="comparison-col">
                        <h4>${d2.term}</h4><p>${d2.definition}</p><div class="example">e.g., "${d2.example}"</div>${getMetadataHTML(d2)}
                    </div>
                </div>
                <div class="metadata"><strong>Tip:</strong> Click the background to clear.</div>`;
            tooltip.html(content).classed("comparison-tooltip", true).style("opacity", 0).style("left", null).style("top", null);
            requestAnimationFrame(() => {
                tooltip.transition().duration(200).style("opacity", 0.95);
                if (!isMobile) {
                    tooltip.style("left", `${width / 2 - tooltip.node().getBoundingClientRect().width / 2}px`).style("top", `${height / 2 - tooltip.node().getBoundingClientRect().height / 2}px`);
                }
            });
        }

        function speak(text, lang = 'en-US') { 
            if ('speechSynthesis' in window && isSoundOn) { 
                window.speechSynthesis.cancel(); 
                let u = new SpeechSynthesisUtterance(text); 
                u.lang = lang; 
                u.rate = 0.9;
                u.onend = () => u = null;
                window.speechSynthesis.speak(u); 
            } 
        }

        function setupTooltipEvents(selection) {
            selection.on("click", handleWordClick).on("mouseover", (event, d) => {
                if (selectedWords.length > 0) return;
                speak(d.term);
                tooltip.transition().duration(200).style("opacity", .95);
                const metadataHTML = getMetadataHTML(d);
                tooltip.html(`<h3>${d.term}</h3><p>${d.definition}</p><div class="example">e.g., "${d.example}"</div>${metadataHTML}`);
                const tooltipNode = tooltip.node();
                const r = tooltipNode.getBoundingClientRect();
                const containerRect = container.node().getBoundingClientRect();
                
                let l = event.pageX - containerRect.left + 15;
                let t = event.pageY - containerRect.top - 28;
                
                if (l + r.width > containerRect.width) { l = event.pageX - containerRect.left - r.width - 15; }
                if (t + r.height > containerRect.height) { t = event.pageY - containerRect.top - r.height - 15; }
                if (t < 0) { t = event.pageY - containerRect.top + 15; }
                if (l < 0) l = 10;
                
                tooltip.style("left", l + "px").style("top", t + "px");
            }).on("mouseout", () => { if (selectedWords.length === 0) { tooltip.transition().duration(500).style("opacity", 0); } });
        }

        function exportAsPNG() {
            const exportArea = d3.select("#chart-container").node();
            html2canvas(exportArea, {
                backgroundColor: '#1a1a2e',
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const ctx = canvas.getContext('2d');
                const text = "Word Radar by ELTcation - www.eltcation.com";
                const padding = 25;
                ctx.font = 'bold 24px sans-serif';
                ctx.fillStyle = 'rgba(224, 224, 224, 0.6)';
                ctx.textAlign = 'center';
                ctx.fillText(text, canvas.width / 2, canvas.height - padding);
                const pngUrl = canvas.toDataURL("image/png");
                const link = document.createElement("a");
                const fileName = `word-radar-${currentRadarData?.hub_word || 'export'}.png`;
                link.download = fileName;
                link.href = pngUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).catch(err => {
                console.error("html2canvas failed:", err);
                alert("Sorry, there was an error exporting the image.");
            });
        }

        async function fetchWordData(payload) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                const response = await fetch('/.netlify/functions/word-radar-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Server Error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (error.name === 'AbortError') { return { error: 'Request timeout - please try again' }; }
                console.error("Failed to fetch word data:", error);
                return { error: error.message };
            }
        }

        function setupSoundToggle() {
            d3.select("#sound-toggle").on("click", () => {
                isSoundOn = !isSoundOn;
                d3.select("#sound-toggle").classed("sound-off", !isSoundOn).select(".control-label").text(isSoundOn ? "Sound ON" : "Sound OFF");
                if (!isSoundOn) { window.speechSynthesis.cancel(); }
            });
        }

        function resetToInitialState() {
            if (!scanner.classed("hidden")) return;
            switchToRadarView().then(() => {
                clearChart();
                mainTitle.text("Enter a word to build its Radar").style("cursor", "default");
                inputContainer.classed("hidden", false);
                senseSelector.classed("hidden", true);
                legend.classed("hidden", true);
                restartBtn.classed("hidden", true);
                exportBtn.classed("hidden", true);
                d3.select("#word-input").property("value", "").node().focus();
                d3.select("#custom-words-input").property("value", "");
                d3.selectAll('.pos-option').classed('selected', false);
                d3.select("#submit-btn").classed("hidden", true);
            });
        }

        function drawRadarBackground() {
            radarBgGroup.selectAll("*").remove();
            const ringCount = 4;
            const ringWidth = maxRadius / ringCount;
            radarBgGroup.selectAll(".radar-ring").data(d3.range(ringCount - 1, -1, -1)).enter().append("circle").attr("class", "radar-ring").attr("r", d => (d + 1) * ringWidth).style("fill", "none");
            radarBgGroup.append("line").attr("class", "axis-line").attr("id", "radar-line-v").attr("x1", 0).attr("y1", -maxRadius).attr("x2", 0).attr("y2", maxRadius);
            radarBgGroup.append("line").attr("class", "axis-line").attr("id", "radar-line-h").attr("x1", -maxRadius).attr("y1", 0).attr("x2", maxRadius).attr("y2", 0);
        }

        function drawSpectrumView() {
            spectrumGroup.selectAll("*").remove();
            spectrumGroup.append("line").attr("class", "spectrum-axis").attr("x1", -maxRadius * 0.9).attr("x2", maxRadius * 0.9);
            spectrumGroup.append("line").attr("class", "spectrum-axis").attr("x1", 0).attr("y1", -spectrumRangeY - 20).attr("x2", 0).attr("y2", spectrumRangeY + 20);
            const labelPadding = isMobile ? 12 : 25;
            spectrumGroup.append("text").attr("class", "spectrum-label spectrum-label-left").attr("x", -maxRadius * 0.9 - labelPadding).attr("text-anchor", "end").attr("dominant-baseline", "middle");
            spectrumGroup.append("text").attr("class", "spectrum-label spectrum-label-right").attr("x", maxRadius * 0.9 + labelPadding).attr("text-anchor", "start").attr("dominant-baseline", "middle");
            spectrumGroup.append("text").attr("class", "spectrum-y-axis-label").attr("x", 5).attr("y", -spectrumRangeY - 8).attr("dominant-baseline", "hanging").text("Formal ↑");
            spectrumGroup.append("text").attr("class", "spectrum-y-axis-label").attr("x", 5).attr("y", spectrumRangeY + 8).attr("dominant-baseline", "auto").text("Informal ↓");
        }

        async function handleAddWord() {
            const wordToAdd = addWordInput.property("value").trim();
            if (!wordToAdd || !currentSpectrumData) return;
            addWordBtn.attr("disabled", true).text("Adding...");
            const payload = {
                wordToAdd: wordToAdd,
                start_word: currentSpectrumData.start_word,
                end_word: currentSpectrumData.end_word
            };
            const newWordData = await fetchWordData(payload);
            if (newWordData && !newWordData.error) {
                if (!currentSpectrumData.words.some(w => w.term === newWordData.term)) {
                    currentSpectrumData.words.push(newWordData);
                    updateSpectrumView(currentSpectrumData.words);
                }
            } else {
                alert(`Could not add word: ${newWordData.error || 'Unknown error'}`);
            }
            addWordInput.property("value", "");
            addWordBtn.attr("disabled", null).text("Add");
        }

        addWordBtn.on("click", handleAddWord);
        addWordInput.on("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                handleAddWord();
            }
        });

        function updateSpectrumView(nodes) {
            const simulation = d3.forceSimulation(nodes)
                .force("x", d3.forceX(d => spectrumScale(d.spectrum_position)).strength(1))
                .force("y", d3.forceY(d => spectrumYScale(d.formality)).strength(1))
                .force("collide", d3.forceCollide(d => bubbleSizeScale(d.frequency) + (isMobile ? 3 : 4)).strength(0.7))
                .stop();
            for (let i = 0; i < 300; ++i) { simulation.tick(); }

            const drag = d3.drag()
                .on("start", (event, d) => {
                    d3.select(event.sourceEvent.target.parentNode).raise().classed("dragging", true);
                })
                .on("drag", (event, d) => {
                    d.x = event.x;
                    d.y = event.y;
                    d3.select(event.sourceEvent.target.parentNode).attr("transform", `translate(${d.x}, ${d.y})`);
                })
                .on("end", (event, d) => {
                    d3.select(event.sourceEvent.target.parentNode).classed("dragging", false);
                    d.spectrum_position = spectrumScale.invert(d.x);
                    d.formality = spectrumYScale.invert(d.y);
                });
            
            const bubbles = bubblesGroup.selectAll(".spectrum-bubble")
                .data(nodes, d => d.term); // Use key function to identify bubbles

            bubbles.exit()
                .transition().duration(300)
                .style("opacity", 0)
                .remove();
            
            const newBubbles = bubbles.enter().append("g")
                .attr("class", "spectrum-bubble word-bubble")
                .attr("transform", d => `translate(${d.x}, ${d.y})`)
                .call(drag);

            newBubbles.append("circle")
                .attr("r", 0)
                .style("fill", d => difficultyColors[d.difficulty] || '#1f77b4')
                .transition().duration(500).delay((d,i) => i*10)
                .attr("r", d => bubbleSizeScale(d.frequency));
            
            newBubbles.append("text")
                .text(d => d.term).attr("dy", "0.3em").style("opacity", 0)
                .transition().duration(500)
                .style("opacity", 1);
            
            newBubbles.append("text")
                .attr("class", "remove-btn")
                .attr("x", d => bubbleSizeScale(d.frequency) * 0.7)
                .attr("y", d => -bubbleSizeScale(d.frequency) * 0.7)
                .text("×")
                .on("click", (event, d) => {
                    event.stopPropagation();
                    currentSpectrumData.words = currentSpectrumData.words.filter(w => w.term !== d.term);
                    updateSpectrumView(currentSpectrumData.words);
                });
            
            setupTooltipEvents(newBubbles);

            bubbles.merge(newBubbles)
                .transition().duration(750).ease(d3.easeCubicOut)
                .attr("transform", d => `translate(${d.x}, ${d.y})`);
            
            spectrumBubbles = bubblesGroup.selectAll(".spectrum-bubble");
        }

        function drawWordBubbles(radarData) {
            const labelOffset = maxRadius + (isMobile ? 15 : 25);
            const axisLabels = [
                { text: 'FORMAL', x: 0, y: -labelOffset, anchor: 'middle' },
                { text: 'FIGURATIVE', x: labelOffset, y: 0, anchor: 'start' },
                { text: 'INFORMAL', x: 0, y: labelOffset, anchor: 'middle' },
                { text: 'LITERAL', x: -labelOffset, y: 0, anchor: 'end' }
            ];

            labelsGroup.selectAll(".axis-label").data(axisLabels).enter().append("text")
                .attr("class", "axis-label")
                .attr("x", d => d.x).attr("y", d => d.y)
                .attr("text-anchor", d => d.anchor)
                .attr("dominant-baseline", "middle")
                .text(d => d.text);

            const nodes = radarData.words.map(d => {
                d.radarX = radarXScale(d.style);
                d.radarY = radarYScale(d.formality);
                return d;
            });
            // --- FIX IS HERE ---
            // Changed 'cconst' to 'const'
            const simulation = d3.forceSimulation(nodes)
                .force("collide", d3.forceCollide(d => bubbleSizeScale(d.frequency) + 4).strength(1))
                .force("x", d3.forceX(d => d.radarX).strength(0.1))
                .force("y", d3.forceY(d => d.radarY).strength(0.1))
                .stop();
            // --- END OF FIX ---
            for (let i = 0; i < 300; ++i) simulation.tick();
            
            currentBubbles = bubblesGroup.selectAll(".word-bubble")
                .data(nodes, d => d.term)
                .enter().append("g").attr("class", "word-bubble");

            currentBubbles.append("circle").attr("r", 0).style("fill", d => difficultyColors[d.difficulty] || '#1f77b4')
                .transition().duration(500).delay((d,i) => i * 20).attr("r", d => bubbleSizeScale(d.frequency));
            currentBubbles.append("text").text(d => d.term).attr("dy", "0.3em").style("opacity", 0)
                .transition().duration(500).delay((d,i) => i * 20).style("opacity", 1);
            currentBubbles.attr("transform", d => `translate(${d.x}, ${d.y})`);
            setupTooltipEvents(currentBubbles);

            const antonymRadius = maxRadius + (isMobile ? 35 : 50);
            const quadrantCenters = [ -Math.PI / 4, Math.PI / 4, 3 * Math.PI / 4, 5 * Math.PI / 4 ];
            const spreadAngle = Math.PI / 8;
            const antonymNodes = radarData.antonyms.map((ant, i) => {
                const baseAngle = quadrantCenters[i % 4];
                const offset = (Math.floor(i / 4) % 2 === 0 ? 1 : -1) * Math.floor(i / 4) * spreadAngle;
                const angle = baseAngle + offset;
                return { term: ant, x: antonymRadius * Math.cos(angle), y: antonymRadius * Math.sin(angle) };
            });
            
            currentAntonymBubbles = antonymsGroup.selectAll(".antonym-bubble")
                .data(antonymNodes, d => d.term)
                .enter().append("g").attr("class", "word-bubble antonym-bubble");

            currentAntonymBubbles.append("circle").attr("r", 0).style("fill", "#d62728")
                .transition().duration(500).delay((d, i) => 500 + i * 50).attr("r", isMobile ? 12 : 16);
            currentAntonymBubbles.append("text").text(d => d.term).attr("dy", "0.3em").style("opacity", 0)
                .transition().duration(500).delay((d, i) => 500 + i * 50).style("opacity", 1);
            currentAntonymBubbles.attr("transform", d => `translate(${d.x}, ${d.y})`);
            
            currentAntonymBubbles.on("click", async (e, d) => {
                e.stopPropagation();
                mainTitle.text(`Generating spectrum for "${currentRadarData.hub_word}" vs "${d.term}"...`);
                scanner.classed("hidden", false);
                try {
                    const spectrumData = await fetchWordData({ word: currentRadarData.hub_word, antonym: d.term });
                    scanner.classed("hidden", true);
                    if (spectrumData && spectrumData.words) {
                        switchToSpectrumView('antonym', spectrumData);
                    } else {
                        mainTitle.text(spectrumData.error || "Could not generate spectrum.");
                    }
                } catch (error) {
                    scanner.classed("hidden", true);
                    mainTitle.text("Error generating spectrum.");
                    console.error(error);
                }
            }).on("mouseover", (e, d) => {
                speak(d.term);
                tooltip.transition().duration(200).style("opacity", .95);
                tooltip.html(`<h3>${d.term}</h3><p><em>An opposite of "${currentRadarData.hub_word}"</em></p>`);
            }).on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
        }
        
        function clearChart() {
            clearComparison();
            if (currentBubbles) currentBubbles.remove();
            if (currentAntonymBubbles) currentAntonymBubbles.remove();
            if (spectrumBubbles) {
                spectrumBubbles.remove();
                spectrumBubbles = null;
            }
            labelsGroup.selectAll(".axis-label").remove();
            updateLegend(null);
        }

        function switchToSpectrumView(type, data) {
            clearComparison();
            currentView = 'spectrum';
            activeSpectrum = type;
            currentSpectrumData = data;

            labelsGroup.transition().duration(500).style("opacity", 0).attr("pointer-events", "none");
            antonymsGroup.transition().duration(500).style("opacity", 0).attr("pointer-events", "none");
            radarBgGroup.transition().duration(500).style("opacity", 0);
            
            spectrumGroup.transition().delay(200).duration(500).style("opacity", 1).attr("pointer-events", "auto");
            addWordContainer.classed("hidden", false);

            if (type === 'antonym') {
                mainTitle.text(`Spectrum: "${data.start_word}" vs "${data.end_word}"`);
                spectrumGroup.select(".spectrum-label-left").text(data.start_word.toUpperCase());
                spectrumGroup.select(".spectrum-label-right").text(data.end_word.toUpperCase());
                if (currentBubbles) {
                    currentBubbles.transition().duration(500).style("opacity", 0).attr("pointer-events", "none");
                }
                updateSpectrumView(data.words);
            }
        }

        function switchToRadarView() {
            return new Promise(resolve => {
                if (currentView !== 'spectrum') { resolve(); return; }
                clearComparison(); 
                currentView = 'radar';
                
                addWordContainer.classed("hidden", true);
                if (spectrumBubbles) {
                    spectrumBubbles.remove();
                    spectrumBubbles = null;
                }
                currentSpectrumData = null;
                activeSpectrum = null;
                if(currentRadarData) mainTitle.text(`Word Radar: "${currentRadarData.hub_word}"`);
                
                spectrumGroup.transition().duration(500).style("opacity", 0).attr("pointer-events", "none");
                radarBgGroup.transition().delay(200).duration(500).style("opacity", 1);
                labelsGroup.transition().delay(200).duration(500).style("opacity", 1).attr("pointer-events", "auto");
                antonymsGroup.transition().delay(200).duration(500).style("opacity", 1).attr("pointer-events", "auto");

                if (currentBubbles) {
                    currentBubbles.transition().duration(1).style("opacity", 1).attr("pointer-events", "auto");

                    const nodes = currentBubbles.data();
                    const simulation = d3.forceSimulation(nodes)
                        .force("collide", d3.forceCollide(d => bubbleSizeScale(d.frequency) + 3).strength(0.8))
                        .force("x", d3.forceX(d => d.radarX).strength(0.1))
                        .force("y", d3.forceY(d => d.radarY).strength(0.1))
                        .stop();
                    for (let i = 0; i < 200; ++i) simulation.tick();

                    currentBubbles.transition().duration(750).ease(d3.easeCubicOut)
                        .attr("transform", d => `translate(${d.x}, ${d.y})`)
                        .end().then(resolve);
                } else { resolve(); }
            });
        }
        
        function updateLegend(data) {
            legend.classed("hidden", !data);
        }
        
        submitBtn.on("click", (event) => { event.preventDefault(); handleFormSubmit(event); });
        drawRadarBackground();
        drawSpectrumView();
        wordForm.on("submit", handleFormSubmit);
        d3.selectAll('#category-input, #custom-words-input').on('keydown', function(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleFormSubmit(event); }});
        d3.select('#word-input').on('input', updateSubmitButtonState);
        d3.selectAll('.pos-option').on('click', function() { d3.selectAll('.pos-option').classed('selected', false); d3.select(this).classed('selected', true); updateSubmitButtonState(); });
        mainTitle.on("click", resetToInitialState);
        setupSoundToggle();
        restartBtn.on("click", resetToInitialState);
        exportBtn.on("click", exportAsPNG);
    });
</script>
</body>
</html>